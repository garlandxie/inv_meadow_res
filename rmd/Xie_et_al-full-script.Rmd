---
title: "Xie_et_all-full_script"
author: "Garland Xie"
date: "09/01/2022"
output:
  pdf_document: default
  html_document: default
  word_document: default
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preamble

This document was last updated on `r format(Sys.Date(), '%B %d %Y')`.

Garland Xie created this annotated R markdown script. The goal of this script is to maximize transparency and reproducibility associated with the following PhD chapter of my dissertation: **Drivers of invasibility in urban meadow restoration (a field study).**

This script is licensed under CC BY-NC-SA 4.0.

## Session info and loading packages

It is important to note that certain functions are preceded by their package sources to help with understanding and reproducing the code (if necessary). This is denoted as "package::function()".

### Load packages

```{r load libraries, message=FALSE}
library(here)           # for creating relative file-paths
library(googlesheets4)  # for importing googlesheet files
library(dplyr)          # for manipulating data
library(knitr)          # for creating tables
library(kableExtra)     # for customizing tables
library(janitor)        # for making 'R-friendly' column names
library(ggplot2)        # for visualizing data 
library(ggrepel)        # for making easy-to-read text labels
library(vegan)          # for analyzing community data matrices
library(patchwork)      # for displaying multiple ggplot2 figures
library(rdryad)         # for importing datasets from DRYAD
library(stringr)        # for manipulating string characters
```

### Session Info

Key information for reproducibility

```{r sessionInfo}
sessionInfo()

```

## Plants of Toronto

This is dataset containing 1,937 plant species that occur in the city of Toronto. It was compiled by Marc W. Cadotte (University of Toronto) from the following data sources [@cadotte2021]:

1.  A list of species compiled through the Cadotte research lab,
2.  A list of species provided by staff at the Rouge National Urban Park,
3.  A list of species compiled by the Royal Ontario Museum,
4.  A list of species from a biological inventory conduced by the Toronto Region Conservation Authority,
5.  A list of plant observations (download on 21 October 2019) from the Global Biodiversity Information Facility,
6.  A collation of natural history observations from Ken Sproule

This dataset has information on origin status. Marc Cadotte compiled it from the Ministry of Natural Resources and Forestry's Natural Heritage Information Centre (<https://www.ontario.ca/page/natural-heritage-information-centre>) to determine whether a species is native or introduced. Here, an introduced species is defined as "those not known occur in the province Ontario prior to European settlement".

This data set is currently archived as a DRYAD data repository [@cadotte2020]. It can be download as a data frame in the R environment through the DRYAD R API:

```{r}

dryad_doi <- "10.5061/dryad.1ns1rn8sg"
dryad_link <- rdryad::dryad_download(dryad_doi)
plants_to <- read.csv(unlist(dryad_link))
```

## Seed bank

### Methods

For the spring sampling season, we collected soil samples for 81 1-m2 plots across nine sites in three different management regimes (i.e., seed drilling, undisturbed, and maintenance mow) in May 2021. Here, we located the centroid of each plot in the field using a handheld GPS. At each plot, we measured a distance of 30 cm away from the centroid. Before sampling, we removed the surface litter layer or gravel. I then took a soil sample using a 3.5-cm diameter soil core to a depth of 5 cm. This procedure was repeated five times to increase the precision and accuracy of the seed bank estimate **(citation)** and reduce the spatial autocorrelation of community abundance and species richness within plots **(citation)**. I combined all five soil samples to one composite seed bank sample per plot into a plastic bag. It is possible to obtain a complete picture of the community dynamics of the seed bank by sampling twice within a growing season such as the spring and fall season **(citation)**. I have also repeated the field measurement protocol for obtaining seed bank samples from October-November 2021. Because fall samples require cold temperatures to break winter dormancy, all spring and fall samples were stored in a freezer at -20 ℃ for up to three weeks prior to processing at the greenhouse. 

Prior to seed emergence methods, we processed soils to remove any litter, roots, rocks, or other debris using a 4 mm sieve. We then filled 81 plastic germination trays with 3 cm of sterilized potting soil. I then spread the field-collected soil samples (one composite sample per plot amounting to 240 cubic centimeter of soil) evenly over the potting soil to ensure complete germination. To serve as a control to track any contaminated seeds from either the greenhouse environment or the potting soil, we filled five additional trays with sterilized potting soil and four additional trays with unsterilized potting (n = 9 for control treatments). All of the trays were randomly dispersed throughout the greenhouse bench. To reduce any spatial effects of environmental heterogeneity (i.e., light intensity and temperature), we completely randomized the trays once a week. We also watered all the trays twice a week to ensure adequate moisture. 

We monitored seed germination over a period of four months (July to October 2021). During this time, we scarified the soil if there was at least a week of no seed germination. Any species that were difficult to identify as either a seedling or a juvenile was also collected and placed into a separate tray and grown until flowering. After the fourth month, we removed all the remaining germinants. While previous seed bank study suggests a monitoring period of six months is required, we were primarily interested in species that germinated first and most abundantly as these have competitive advantage in establishment as propagule pressure for both exotic and native plant species. We plan to replicate the seedling emergence for the fall sampling season starting from November 2021 to February 2022. 

### Import data

Read in data from a Google spreadsheet API

```{r import spring seed bank, message=FALSE}
# spring sampling season
sb_spr_link <- "https://docs.google.com/spreadsheets/d/1O1Ll_PsW3qKwdZ_xnTrDKT_kGnpLGvtUKBQ73zvvBBM/edit?usp=sharing"

seed_bank_spr <- googlesheets4::read_sheet(
    sb_spr_link, 
    sheet = "raw_data"
    )
```

```{r import fall seed bank, message=FALSE}
# fall sampling season
sb_fall_link <- "https://docs.google.com/spreadsheets/d/1SWlk5eWdk3IOMFS9nv61p1HW-Tw4K3yR-tAIkAMlzs4/edit?usp=sharing"

seed_bank_fall <- googlesheets4::read_sheet(
  sb_fall_link, 
  sheet = "raw_data"
  )

```

```{r import binomial latin , message=FALSE}

# binomial latin names
taxon_link <- "https://docs.google.com/spreadsheets/d/1r-T9lY1Osjez8SKKoCUHRi5ftbHBvgFn2Xk-IPqc0z4/edit?usp=sharing"

sb_taxa <- googlesheets4::read_sheet(
  taxon_link, 
  sheet = "raw_data"
  )

```

\newpage

### Metadata

Descriptions of raw data files:

-   **seed_bank_spring** - seedling emergent data from spring season and sampled in the greenhouse from July to October 2021

-   **seed_bank_fall** - seedling emergent data from fall season and sampled in the greenhouse from July to October 2021

Descriptions of each variable in the data frames:

-   **season**: a factor variable that indicates the sampling season (i.e., Spring or Fall)

-   **section:** a factor variable that represents a specific section in the Meadoway (*i.e.*, section 2 or section 4)

-   **site:** a factor variable that represents a sampled site (40m X 40m area)

-   **treatment:** a factor variable that represents a management regime (*i.e.*, tilling, restored, or mowing) or control treatments (*i.e.*, potting soil, sterilized potting soil)

-   **plot:** a factor variable represent a sampled plot within a site

-   **date_ymd:** a date of when seedling emergent was identified and recorded (using ISO 8601 format)

-   **spp_code**: a character string that represents an abbreviation of the taxonomic species name **(see Table X)**.

-   **abund:** an integer variable that represents the seedling emergent abundance for a specific plot

-   **sampled_by**: a character string that represents the initials of the surveyor

-   **comments**: additional comments

### Data wrangling

**Reorganize data.** For each sampling season, subset the seed bank dataset to six sites that are congruent with the above-ground biomass dataset. Then, merge the subset with the taxonomic data to obtain binomial latin species name (e.g., *Alliara_petiolata).* Finally, combine both fall and spring seed bank data into a single data-frame.

```{r subset fall seed bank}
sb_spring_tidy <- seed_bank_spr %>%
  janitor::clean_names() %>%
  dplyr::filter(
    site %in% c("BNSH", "GRNB", "DAVE", "KENN", "TIMH", "VICP")
    ) %>%
  left_join(sb_taxa %>% janitor::clean_names(), by = c("spp_code" = "code")) %>%
  mutate(binom_latin = paste(genus, species, sep = "_")) %>%
  select(
    season, 
    section, 
    site, 
    treatment, 
    plot, 
    date_ymd, 
    spp_code, 
    binom_latin,
    abund
  )

sb_fall_tidy <- seed_bank_fall %>%
  janitor::clean_names() %>%
  dplyr::filter(
    site %in% c("BNSH", "GRNB", "DAVE", "KENN", "TIMH", "VICP")
    ) %>%
  left_join(sb_taxa %>% janitor::clean_names(), by = c("spp_code" = "code")) %>%
  mutate(binom_latin = paste(genus, species, sep = "_")) %>%
  select(
    season, 
    section, 
    site, 
    treatment, 
    plot, 
    date_ymd, 
    spp_code, 
    binom_latin,
    abund
  )

sb_tidy <- rbind(sb_fall_tidy, sb_spring_tidy)
```

**Summarize data**. The raw data for seedling emergent abundance was collected at specific dates (y-m-d) within specific plots. Temporal dimensions are beyond the scope of this analysis, and the data will thus be summarized as **total** **seedling emergent density per plot**. This measured variable make sense since we collected soil cores within a defined volume (3.5 cm diameter and a 5 cm depth, approximating the shape of a cylinder).

```{r summarize seed bank data, message=FALSE}
sb_summary <- sb_tidy %>%
  group_by(season, section, site, treatment, plot) %>%
  summarize(
    seed_emer_density = sum(abund, na.rm = TRUE)
  ) %>%
  ungroup()
```

### Exploratory data analysis

#### Propagule Density 

-   How many seeds were in the seed bank across both sampling season?`r sum(sb_summary$seed_emer_density)` seeds.

-   How many seeds were in the seed bank for the fall season? `r sum(filter(sb_summary, season == "Fall")$seed_emer_density)` seeds.

-   How many seeds were in the seed bank in the spring season?`r sum(filter(sb_summary, season == "Spring")$seed_emer_density)` seeds.

-   How does seed bank density differ across sites? See figure below. Note that each point represent a particular plot.

    ```{r seed bank density in section 2, echo=FALSE}

    sb_summary %>%
      mutate(
        season    = factor(season, levels = c("Spring", "Fall")), 
        treatment = case_when(
          treatment == "RES" ~ "Undisturbed",
          treatment == "TIL" ~ "Heavily-Tilled"
          )
        ) %>%
      filter(section == "S2") %>%
      ggplot(aes(x = site, y = seed_emer_density, fill = site)) +
      geom_boxplot() + 
      geom_point(alpha = 0.1) + 
      facet_wrap(~season) + 
      labs(
        title = "Section 2 - Heavily-Tilled Sites",
        x = NULL, 
        y = "Seedling emergent density (per plot)") + 
      theme_bw()
    ```

    ```{r seed bank density in section 4, echo=FALSE}

    sb_summary %>%
      mutate(
        season    = factor(season, levels = c("Spring", "Fall")), 
        treatment = case_when(
          treatment == "RES" ~ "Undisturbed",
          treatment == "TIL" ~ "Heavily-Tilled"
          )
        ) %>%
      filter(section == "S4") %>%
      ggplot(aes(x = site, y = seed_emer_density, fill = site)) +
      geom_boxplot() + 
      geom_point(alpha = 0.1) + 
      facet_wrap(~season) + 
      labs(
        title = "Section 4 - Undisturbed Sites",
        x = NULL, 
        y = "Seedling emergent density (per plot)") + 
      theme_bw()
    ```

\newpage

```{r fig.height=5, fig.width=5, message=FALSE, warning=FALSE, include=FALSE}

spring_S2_comm_matrix <- sb_tidy %>%
  filter(season == "Spring" & treatment == "TIL") %>%
  group_by(site, binom_latin) %>%
  summarize(abundance = sum(abund, na.rm = TRUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(
    id_cols = c("site"), 
    names_from = binom_latin, 
    values_from = abundance
    ) %>%
  mutate(across(.cols = everything(), ~ tidyr::replace_na(.x, 0))) %>%
  tibble::column_to_rownames(var = "site") %>%
  as.data.frame()

spring_S2_RA <- BiodiversityR::rankabundance(spring_S2_comm_matrix) %>%
    as.data.frame() %>%
    tibble::rownames_to_column(var = "species") 
```

```{r fig.height=5, fig.width=5, message=FALSE, warning=FALSE, include=FALSE}

fall_S2_comm_matrix <- sb_tidy %>%
  filter(season == "Fall" & treatment == "TIL") %>%
  group_by(site, binom_latin) %>%
  summarize(abundance = sum(abund, na.rm = TRUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(
    id_cols = c("site"), 
    names_from = binom_latin, 
    values_from = abundance
    ) %>%
  mutate(across(.cols = everything(), ~ tidyr::replace_na(.x, 0))) %>%
  tibble::column_to_rownames(var = "site") %>%
  as.data.frame()

fall_S2_RA <- BiodiversityR::rankabundance(fall_S2_comm_matrix) %>%
    as.data.frame() %>%
    tibble::rownames_to_column(var = "species") 
```

```{r rank-abundance for TIL, fig.height=5, fig.width=5, message=FALSE, warning=FALSE, include=FALSE}

S2_comm_matrix <- sb_tidy %>%
  filter(treatment == "TIL") %>%
  group_by(site, binom_latin) %>%
  summarize(abundance = sum(abund, na.rm = TRUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(
    id_cols = c("site"), 
    names_from = binom_latin, 
    values_from = abundance
    ) %>%
  mutate(across(.cols = everything(), ~ tidyr::replace_na(.x, 0))) %>%
  tibble::column_to_rownames(var = "site") %>%
  as.data.frame()

S2_RA <- BiodiversityR::rankabundance(S2_comm_matrix) %>%
    as.data.frame() %>%
    tibble::rownames_to_column(var = "species") 

```

```{r echo=FALSE, fig.height=6, fig.width=5, message=FALSE, warning=FALSE}

spr_S2_RA_plot <- spring_S2_RA %>%
    ggplot(aes(x = rank, y = abundance)) + 
    geom_text_repel(aes(label = species)) + 
    geom_point(alpha = 0.5) +
    geom_line(alpha = 0.5) + 
    labs(title = "Heavily-tilled management in Spring") +
    theme_bw()

fal_S2_RA_plot <- fall_S2_RA %>%
    ggplot(aes(x = rank, y = abundance)) + 
    geom_text_repel(aes(label = species)) + 
    geom_point(alpha = 0.5) +
    geom_line(alpha = 0.5) + 
    labs(title = "Heavily-tilled management in Fall") +
    theme_bw()

S2_RA_plot <- S2_RA %>%
    ggplot(aes(x = rank, y = abundance)) + 
    geom_text_repel(aes(label = species)) + 
    geom_point(alpha = 0.5) +
    geom_line(alpha = 0.5) + 
    labs(
      title = "Heavily-tilled management (Fall + Spring)", 
      x     = "rank",
      y     = "seedling abundance"
      ) +
    theme_bw()

spr_S2_RA_plot / fal_S2_RA_plot / S2_RA_plot
```

\newpage

```{r fig.height=5, fig.width=5, message=FALSE, warning=FALSE, include=FALSE}

spring_S4_comm_matrix <- sb_tidy %>%
  filter(season == "Spring" & treatment == "RES") %>%
  group_by(site, binom_latin) %>%
  summarize(abundance = sum(abund, na.rm = TRUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(
    id_cols = c("site"), 
    names_from = binom_latin, 
    values_from = abundance
    ) %>%
  mutate(across(.cols = everything(), ~ tidyr::replace_na(.x, 0))) %>%
  tibble::column_to_rownames(var = "site") %>%
  as.data.frame()

spring_S4_RA <- BiodiversityR::rankabundance(spring_S4_comm_matrix) %>%
    as.data.frame() %>%
    tibble::rownames_to_column(var = "species") 
```

```{r fig.height=5, fig.width=5, message=FALSE, warning=FALSE, include=FALSE}

fall_S4_comm_matrix <- sb_tidy %>%
  filter(season == "Fall" & treatment == "RES") %>%
  group_by(site, binom_latin) %>%
  summarize(abundance = sum(abund, na.rm = TRUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(
    id_cols = c("site"), 
    names_from = binom_latin, 
    values_from = abundance
    ) %>%
  mutate(across(.cols = everything(), ~ tidyr::replace_na(.x, 0))) %>%
  tibble::column_to_rownames(var = "site") %>%
  as.data.frame()

fall_S4_RA <- BiodiversityR::rankabundance(fall_S4_comm_matrix) %>%
    as.data.frame() %>%
    tibble::rownames_to_column(var = "species") 
```

```{r, fig.height=5, fig.width=5, message=FALSE, warning=FALSE, include=FALSE}

S4_comm_matrix <- sb_tidy %>%
  filter(treatment == "RES") %>%
  group_by(site, binom_latin) %>%
  summarize(abundance = sum(abund, na.rm = TRUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(
    id_cols = c("site"), 
    names_from = binom_latin, 
    values_from = abundance
    ) %>%
  mutate(across(.cols = everything(), ~ tidyr::replace_na(.x, 0))) %>%
  tibble::column_to_rownames(var = "site") %>%
  as.data.frame()

S4_RA <- BiodiversityR::rankabundance(S4_comm_matrix) %>%
    as.data.frame() %>%
    tibble::rownames_to_column(var = "species") 

```

```{r echo=FALSE, fig.height=6, fig.width=5, message=FALSE, warning=FALSE}

spr_S4_RA_plot <- spring_S4_RA %>%
    ggplot(aes(x = rank, y = abundance)) + 
    geom_text_repel(aes(label = species)) + 
    geom_point(alpha = 0.5) +
    geom_line(alpha = 0.5) + 
    labs(title = "Undisturbed sites in Spring") +
    theme_bw()

fal_S4_RA_plot <- fall_S4_RA %>%
    ggplot(aes(x = rank, y = abundance)) + 
    geom_text_repel(aes(label = species)) + 
    geom_point(alpha = 0.5) +
    geom_line(alpha = 0.5) + 
    labs(title = "Undisturbed sites in Fall") +
    theme_bw()

S4_RA_plot <- S4_RA %>%
    ggplot(aes(x = rank, y = abundance)) + 
    geom_text_repel(aes(label = species)) + 
    geom_point(alpha = 0.5) +
    geom_line(alpha = 0.5) + 
    labs(
      title = "Undisturbed sites (Fall + Spring)", 
      x     = "rank",
      y     = "seedling abundance"
      ) +
    theme_bw()

spr_S4_RA_plot / fal_S4_RA_plot / S4_RA_plot
```

\newpage

#### Community composition

It would be interesting to explore how the community composition of the seed bank differ among plots, sites, seasons, and management regimes. Here, two possible approaches to answer this question are: (1) principal coordinate analysis (PCoA), and (2) non-metric dimensional scaling (NMDS).

Using a dissimilarity measure (e.g., Bray-Curtis), both can help visualize close objects with similar values (*i.e.,* seed banks with similar community composition are close together) and distance objects with different values. Here, I will follow [@borcard2011] recommendation on using PCoA, instead than NMDS, for this analysis.\

```{r echo=FALSE, message=FALSE, warning=FALSE}

spring_comm_matrix <- sb_spring_tidy %>%
  group_by(site, binom_latin) %>%
  summarize(abundance = sum(abund, na.rm = TRUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(
    id_cols = c("site"), 
    names_from = binom_latin, 
    values_from = abundance
    ) %>%
  mutate(across(.cols = everything(), ~ tidyr::replace_na(.x, 0))) %>%
  tibble::column_to_rownames(var = "site") %>%
  as.data.frame()

spring_comm_bray <- vegan::vegdist(spring_comm_matrix, method = "bray")
spring_comm_pcoa <- cmdscale(
  spring_comm_bray, 
  k = (nrow(spring_comm_matrix)- 1),
  eig = TRUE
)

spring_comm_pcoa %>%
  vegan::scores(choices = c(1, 2)) %>%
  as.data.frame() %>%
  mutate(
    site = rownames(.), 
    mgt  = case_when(
      site %in% c("GRNB", "BNSH", "DAVE") ~ "Undisturbed", 
      site %in% c("KENN", "TIMH", "VICP") ~ "Heavily-Tilled")
    ) %>%
  ggplot(aes(x = Dim1, y = Dim2, col = mgt)) + 
  geom_text(aes(label = site)) + 
  xlim(-0.5, 0.5) + 
  ylim(-0.5, 0.5) + 
  scale_color_discrete(name = "Management Regime") + 
  labs(
    title = "Seed Bank Community Composition - Spring",
    x = "PCoA1", 
    y = "PCoA2") + 
  theme_bw()
  
```

```{r echo=FALSE, message=FALSE, warning=TRUE}
fall_comm_matrix <- sb_fall_tidy %>%
  group_by(site, binom_latin) %>%
  summarize(abundance = sum(abund, na.rm = TRUE)) %>%
  ungroup() %>%
  tidyr::pivot_wider(
    id_cols = c("site"), 
    names_from = binom_latin, 
    values_from = abundance
    ) %>%
  mutate(across(.cols = everything(), ~ tidyr::replace_na(.x, 0))) %>%
  tibble::column_to_rownames(var = "site") %>%
  as.data.frame()

fall_comm_bray <- vegan::vegdist(fall_comm_matrix, method = "bray")
fall_comm_pcoa <- cmdscale(
  fall_comm_bray, 
  k = (nrow(fall_comm_matrix)- 1),
  eig = TRUE
)

fall_comm_pcoa %>%
  vegan::scores(choices = c(1, 2)) %>%
  as.data.frame() %>%
  mutate(
    site = rownames(.), 
    mgt  = case_when(
      site %in% c("GRNB", "BNSH", "DAVE") ~ "Undisturbed", 
      site %in% c("KENN", "TIMH", "VICP") ~ "Heavily-Tilled")
    ) %>%
  ggplot(aes(x = Dim1, y = Dim2, col = mgt)) + 
  geom_text(aes(label = site)) + 
  xlim(-0.5, 0.5) + 
  ylim(-0.5, 0.5) + 
  scale_color_discrete(name = "Management Regime") + 
  labs(
    title = "Seed Bank Community Composition - Fall",
    x = "PCoA1", 
    y = "PCoA2") + 
  theme_bw()
```

#### Origin Status

It would be interesting to see how many of the seed species are either native or introduced, across different management regimes. The Toronto Region Conservation Authority has dedicated on-the-field crew to evaluate environmental conditions and then till the soil to deplete the seed bank of introduced species (including invasives). This is done to ensure the successful sowing and establishment of native species from a carefully-curated seed mix.

The results shown here are the [restoration outcomes]{.ul}. How many native species are in the soil seed bank? And how many species are introduced? Note that some native species may not be in the seed mix and may be in the seed bank due to spontaneous colonization from outside the Meadoway footprint.

```{r}
plants_to_tidy <- plants_to %>%
  janitor::clean_names() %>%
  select(taxa = scientific_name, exotic_native) %>%
  mutate(taxa = str_replace(taxa, pattern = " ", replacement = "_"))

sb_org_status <- sb_tidy %>%
  left_join(plants_to_tidy, by = c("binom_latin" = "taxa")) %>%
  
  # fix taxonomic synonyms across both datasets
  # do this manually (only small number of cases to fix)
  mutate(exotic_native = case_when(
    
   # cross-referenced with the Plants of Toronto df
   binom_latin == "Conyza_canadensis" ~ "E", 
   binom_latin == "Acalypha_rhomboidea" ~ "N", 
   binom_latin == "Verbenum_urticifolia" ~ "N",
   binom_latin == "Oligoneuron_rigidium" ~ "N",
   
   # did not show up in Plants of Toronto
   # cross-referenced with Plants USDA 
   binom_latin == "Mentha_arvensis" ~ "N",
   binom_latin == "Pycnanthemum_muticum" ~ "E",
   binom_latin == "Sinapsis_alba" ~ "E",
    TRUE ~ exotic_native)
  )

View(filter(sb_org_status, is.na(exotic_native)))
```

# References
